<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ganesh Utsav 2025 - Keshav Kunj</title>
<style>
  :root {
    --primary: #ff6f00;
    --secondary: #ffd54f;
    --bg: #fff3e0;
    --text: #2c3e50;
    --card-bg: #ffffff;
    --shadow: 0 4px 10px rgba(0,0,0,0.15);
    --radius: 12px;
  }
  body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); }
  header { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 10; }
  header h1 { margin: 0; font-size: 1.8rem; }
  nav { display: flex; justify-content: center; gap: 0.5rem; background: var(--card-bg); box-shadow: var(--shadow); padding: 0.5rem; position: sticky; top: 60px; z-index: 9; }
  nav button { border: none; padding: 0.6rem 1rem; border-radius: 20px; cursor: pointer; background: var(--secondary); font-weight: bold; }
  nav button.active { background: var(--primary); color: white; }
  main { padding: 1rem; }
  section { display: none; }
  section.active { display: block; }
  .event-card, .contact-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1rem; padding: 1rem; }
  .event-date { font-weight: bold; color: var(--primary); margin-bottom: 0.5rem; }
  .event-item { margin-bottom: 0.5rem; padding: 0.5rem; border-left: 3px solid var(--secondary); }
  .event-name { font-weight: bold; }
  .event-time { font-size: 0.9rem; color: gray; }
  .rules { font-size: 0.9rem; margin-top: 0.3rem; color: #444; }
  .participants { font-size: 0.9rem; margin-top: 0.3rem; }
  .participants strong { display: block; margin-bottom: 0.2rem; }
  .contact-person { margin-bottom: 0.5rem; }
  .contact-person strong { color: var(--primary); }
</style>
</head>
<body>
<header>
  <h1>Ganesh Utsav 2025</h1>
  <h2>33, Keshav Kunj Society</h2>
</header>

<nav>
  <button class="active" onclick="showSection('schedule')">Schedule</button>
  <button onclick="showSection('rules')">Rules</button>
  <button onclick="showSection('participants')">Participants</button>
  <button onclick="showSection('contacts')">Contacts</button>
</nav>

<main>
  <section id="schedule" class="active"><h2>Event Schedule</h2><div id="event-list"></div></section>
  <section id="rules"><h2>Game Rules</h2><div id="rules-list"></div></section>
  <section id="participants"><h2>Participants</h2><div id="participants-list"></div></section>
  <section id="contacts"><h2>Pooja Committee Contacts</h2><div id="contact-list" class="contact-card"></div></section>
<section id="sports-stats" class="event-card">
  <h2>Sports Registrations</h2>
  <div id="game-counts">Loading...</div>
</section>	
</main>

<script>
async function loadData() {
  const [eventsRes, contactsRes] = await Promise.all([
    fetch("events.json"), fetch("contacts.json")
  ]);
  const eventsData = await eventsRes.json();
 // const contacts = await contactsRes.json();
  renderEvents(eventsData);
  renderRules(eventsData);
  renderParticipants(eventsData);
 // renderContacts(contacts);
renderGameCounts();	
}

async function getGameCounts(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("Failed to fetch CSV");
  const csv = await res.text();

  const rows = csv.split(/\r?\n/).filter(r => r.trim() !== "");
  const header = rows[0].split(",");

  // find column that contains participant's game choices
  const gameColIndex = header.findIndex(h =>
    /game/i.test(h) || /choose/i.test(h) || /sport/i.test(h)
  );

  const counts = { Football: 0, Cricket: 0, Badminton: 0, Carrom:0, Chess:0, Table:0  , Sprint:0 , Jalebi:0  };

  rows.slice(1).forEach(row => {
    const cols = row.split(",");
    const cell = cols[gameColIndex]?.trim();
    if (!cell) return;

    // split multiple games by comma
    const games = cell.split(/[,;]/).map(g => g.trim().toLowerCase());

    games.forEach(g => {
      if (g.includes("Football")) counts.Football++;
      if (g.includes("Cricket")) counts.Cricket++;
      if (g.includes("Badminton")) counts.Badminton++;
	 if (g.includes("Carrom")) counts.Carrom++;
		 if (g.includes("Chess")) counts.Chess++;
		 if (g.includes("Table")) counts.Table++;
		 if (g.includes("Sprint")) counts.Sprint++;
		 if (g.includes("Jalebi")) counts.Jalebi++;
    });
  });

  return counts;
}

async function renderGameCounts() {
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxqZ2VmLZ76VU7QZi7dKdHYBxNl8uWGI3rd9b-Un2bkWDcX88pHqTrjNhuYZzZN4HYyIIPxOAEZ36b/pub?output=csv";
  try {
    const counts = await getGameCounts(url);
    document.getElementById("game-counts").innerHTML = `
      <div><strong>Football:</strong> ${counts.Football}</div>
      <div><strong>Cricket:</strong> ${counts.Cricket}</div>
      <div><strong>Badminton:</strong> ${counts.Badminton}</div>
	 
	<div><strong>Carrom:</strong> ${counts.Carrom}</div>
	 <div><strong>Chess:</strong> ${counts.Chess}</div>
   <div><strong>Table Tennis:</strong> ${counts.Table}</div>
    <div><strong>Sprint Race:</strong> ${counts.Sprint}</div>
	 <div><strong>Jalebi Race:</strong> ${counts.Jalebi}</div>


    `;
  } catch (err) {
    console.error(err);
    document.getElementById("game-counts").textContent = "Unable to load stats";
  }
}


	


async function getRegistrationCount(rawUrl) {
  const url = rawUrl.trim();
  // cache-buster to avoid any sticky CDN caching
  const sep = url.includes("?") ? "&" : "?";
  const fetchUrl = `${url}${sep}cb=${Date.now()}`;

  // timeout guard
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), 10000);

  try {
    const res = await fetch(fetchUrl, { mode: "cors", cache: "no-store", signal: ctrl.signal });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const csv = await res.text();

    // Robust line split, ignore header + blank lines
    const lines = csv.split(/\r?\n/).filter((line, idx) => idx > 0 && line.trim() !== "");
    return lines.length; // number of responses
  } finally {
    clearTimeout(t);
  }
}

function renderStats(statsDiv, url) {
  statsDiv.textContent = "Loading registrations...";
  getRegistrationCount(url)
    .then(total => { statsDiv.textContent = `Registrations: ${total}`; })
    .catch(err => { 
      console.error("Stats fetch failed:", err, url);
      statsDiv.textContent = "Stats unavailable";
    });
}	

function renderEvents(eventsData) {
  const container = document.getElementById("event-list");
  eventsData.forEach((day, index) => {
    const card = document.createElement("div");
    card.className = "event-card";

    const header = document.createElement("div");
    header.className = "event-header";
    header.innerHTML = `<span>${day.date}</span><span>+</span>`;

    const itemsWrap = document.createElement("div");
    itemsWrap.className = "event-items";

    day.items.forEach(ev => {
      const item = document.createElement("div");
      item.className = "event-item";
      item.innerHTML = `<div class="event-name">${ev.name}</div>
        <div class="event-time">${ev.time || ""}</div>`;
      if (ev.link) {
        const link = document.createElement("a");
        link.href = ev.link;
        link.target = "_blank";
        link.className = "form-link";
        link.textContent = "Form Link";
        item.appendChild(link);
      }
      if (ev.contacts && ev.contacts.length) {
        const contactsDiv = document.createElement("div");
        contactsDiv.className = "contact-persons";
        contactsDiv.innerHTML = "Contact: " + ev.contacts.map(c => 
          `<a href="tel:${c.number}">${c.name} (${c.number})</a>`).join(", ");
        item.appendChild(contactsDiv);
      }
      if (ev.statsUrl) {
		  const statsDiv = document.createElement("div");
		  statsDiv.style.fontSize = "0.85rem";
		  statsDiv.style.color = "gray";
		  item.appendChild(statsDiv);           // append first so the user sees "Loading..."
		  renderStats(statsDiv, ev.statsUrl);   // then load
		}

      itemsWrap.appendChild(item);
    });

    // Set default open for first tab
    if (index === 0) {
      itemsWrap.style.display = "block";
      header.querySelector("span:last-child").textContent = "-";
    }

    header.onclick = () => {
      const isOpen = itemsWrap.style.display === "block";
      itemsWrap.style.display = isOpen ? "none" : "block";
      header.querySelector("span:last-child").textContent = isOpen ? "+" : "-";
    };

    card.appendChild(header);
    card.appendChild(itemsWrap);
    container.appendChild(card);
  });
}

function renderRules(eventsData) {
  const rulesList = document.getElementById("rules-list");
  eventsData.forEach(day => {
    day.items.forEach(ev => {
      if(ev.rules) {
        const div = document.createElement("div");
        div.className = "event-item";
        div.innerHTML = `<div class="event-name">${ev.name}</div><div class="rules">${ev.rules}</div>`;
        rulesList.appendChild(div);
      }
    });
  });
}

function renderParticipants(eventsData) {
  const partList = document.getElementById("participants-list");
  eventsData.forEach(day => {
    day.items.forEach(ev => {
      if(ev.participants && ev.participants.length) {
        const div = document.createElement("div");
        div.className = "event-item";
        div.innerHTML = `<div class="event-name">${ev.name}</div><div class="participants"><strong>Participants:</strong>${ev.participants.map(p=>p.name).join(", ")}</div>`;
        partList.appendChild(div);
      }
    });
  });
}

function renderContacts(contacts) {
  const list = document.getElementById("contact-list");
  contacts.forEach(c => {
    const div = document.createElement("div");
    div.className = "contact-person";
    div.innerHTML = `<strong>${c.name}</strong> - <a href="tel:${c.number}">${c.number}</a>`;
    list.appendChild(div);
  });
}

function showSection(id) {
  document.querySelectorAll("main section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelector(`nav button[onclick="showSection('${id}')"]`).classList.add("active");
}

loadData();
</script>
</body>
</html>
